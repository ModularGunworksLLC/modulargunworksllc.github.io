<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Price Management Tool - Modular Gunworks LLC</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 30px;
    }

    h1 {
      color: #181a1b;
      margin-bottom: 10px;
      font-size: 2rem;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 0.95rem;
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 15px;
      margin-bottom: 30px;
      align-items: end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    input[type="text"],
    input[type="number"],
    select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.95rem;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: #c00;
      box-shadow: 0 0 0 3px rgba(204,0,0,0.1);
    }

    button {
      padding: 10px 20px;
      background: #c00;
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 0.95rem;
    }

    button:hover {
      background: #a00;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .secondary-btn {
      background: #0066cc;
    }

    .secondary-btn:hover {
      background: #0052a3;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    th {
      background: #f0f0f0;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #ddd;
      font-size: 0.9rem;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 0.9rem;
    }

    tr:hover {
      background: #f9f9f9;
    }

    .price-input {
      width: 100px;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .price-input.changed {
      background: #fffacd;
      border-color: #ffc700;
    }

    .price-diff {
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.85rem;
    }

    .price-diff.higher {
      background: #fee;
      color: #c00;
    }

    .price-diff.lower {
      background: #efe;
      color: #060;
    }

    .category-header {
      background: #007bff;
      color: white;
      padding: 12px;
      font-weight: 600;
      font-size: 1rem;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #f9f9f9;
      border-left: 4px solid #c00;
      padding: 15px;
      border-radius: 4px;
    }

    .stat-label {
      color: #666;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #181a1b;
    }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #0066cc;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
      color: #333;
      font-size: 0.9rem;
    }

    .warning-box {
      background: #fff3cd;
      border-left: 4px solid #ffc700;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
      color: #333;
      font-size: 0.9rem;
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 12px;
      font-size: 0.9rem;
    }

    .page-info {
      display: flex;
      align-items: center;
      padding: 0 15px;
      color: #666;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .action-buttons button {
      padding: 6px 12px;
      font-size: 0.85rem;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üìä Price Management Tool</h1>
    <p class="subtitle">Compare your prices with competitors and manage updates</p>

    <div class="info-box">
      ‚ÑπÔ∏è <strong>How to use:</strong> Search for products, enter competitor prices, adjust your prices, and save changes. 
      Your updates are stored locally in browser storage. When you get a new CSV, reimport it to overwrite these changes.
    </div>

    <div class="stats" id="stats-container"></div>

    <div class="controls">
      <div class="control-group">
        <label for="category-filter">Category:</label>
        <select id="category-filter">
          <option value="">All Categories</option>
          <option value="ammunition">Ammunition</option>
          <option value="optics">Optics</option>
          <option value="guns">Guns</option>
          <option value="magazines">Magazines</option>
          <option value="gear">Gear</option>
          <option value="reloading">Reloading</option>
          <option value="survival">Survival</option>
          <option value="gun-parts">Gun Parts</option>
        </select>
      </div>

      <div class="control-group">
        <label for="search-box">Search Product Name or SKU:</label>
        <input type="text" id="search-box" placeholder="e.g., 9mm, .223, Federal...">
      </div>

      <div class="control-group">
        <label for="brand-filter">Brand:</label>
        <input type="text" id="brand-filter" placeholder="Filter by brand...">
      </div>

      <div class="action-buttons">
        <button class="secondary-btn" onclick="exportPrices()">üì• Export CSV</button>
        <button class="secondary-btn" onclick="resetAllPrices()">‚Ü∫ Reset Prices</button>
      </div>
    </div>

    <div class="table-wrapper">
      <table id="products-table">
        <thead>
          <tr>
            <th>Product Name</th>
            <th>Brand</th>
            <th>Category</th>
            <th>MSRP (Main)</th>
            <th>MAP (Sale)</th>
            <th>Competitor Comparison</th>
            <th>PSA Price</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr><td colspan="8" style="text-align: center; color: #999;">Loading products...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="pagination" id="pagination"></div>

    <div class="warning-box" style="margin-top: 30px;">
      ‚ö†Ô∏è <strong>Note:</strong> Changes are saved in your browser's local storage. To make permanent updates to your product database, 
      export the CSV and reimport it into your system when ready.
    </div>
  </div>

  <script>
    const ITEMS_PER_PAGE = 20;
    let currentPage = 1;
    let allProducts = [];
    let filteredProducts = [];

    // Load all product data
    async function loadProducts() {
      try {
        const categories = ['ammunition', 'guns', 'optics', 'magazines', 'gear', 'reloading', 'survival', 'gun-parts'];
        let products = [];

        for (const category of categories) {
          const response = await fetch(`../Data/${category}-data.json`);
          const data = await response.json();
          
          // Flatten the data based on structure
          if (Array.isArray(data)) {
            products = products.concat(data.map(p => ({ ...p, category })));
          } else {
            // Handle nested structure
            Object.values(data).forEach(items => {
              if (Array.isArray(items)) {
                products = products.concat(items.map(p => ({ ...p, category })));
              }
            });
          }
        }

        // Load saved prices from localStorage
        const savedPrices = JSON.parse(localStorage.getItem('modular-gunworks-prices') || '{}');
        products = products.map(p => {
          if (savedPrices[p.sku || p.id]) {
            return { ...p, msrp: savedPrices[p.sku || p.id].msrp, map: savedPrices[p.sku || p.id].map, psa_price: savedPrices[p.sku || p.id].psa_price };
          }
          return p;
        });

        allProducts = products;
        displayStats();
        filterProducts();
      } catch (error) {
        console.error('Error loading products:', error);
        document.getElementById('table-body').innerHTML = '<tr><td colspan="8" style="text-align: center; color: #c00;">Error loading products. Check console.</td></tr>';
      }
    }

    function filterProducts() {
      const searchTerm = document.getElementById('search-box').value.toLowerCase();
      const categoryFilter = document.getElementById('category-filter').value;
      const brandFilter = document.getElementById('brand-filter').value.toLowerCase();

      filteredProducts = allProducts.filter(p => {
        const matchesSearch = !searchTerm || 
          p.title.toLowerCase().includes(searchTerm) || 
          (p.id && p.id.toLowerCase().includes(searchTerm));
        const matchesCategory = !categoryFilter || p.category === categoryFilter;
        const matchesBrand = !brandFilter || (p.brand && p.brand.toLowerCase().includes(brandFilter));
        
        return matchesSearch && matchesCategory && matchesBrand;
      });

      currentPage = 1;
      displayProducts();
    }

    function displayProducts() {
      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      const end = start + ITEMS_PER_PAGE;
      const pageProducts = filteredProducts.slice(start, end);

      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';

      if (pageProducts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">No products found.</td></tr>';
        document.getElementById('pagination').innerHTML = '';
        return;
      }

      pageProducts.forEach((product, index) => {
        const priceDiff = calculatePriceDiff(product);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${product.name}</strong></td>
          <td>${product.brand || '-'}</td>
          <td><span style="background: #f0f0f0; padding: 3px 8px; border-radius: 3px; font-size: 0.85rem;">${product.category}</span></td>
          <td>
            <input type="number" class="price-input" value="${product.msrp || 0}" 
              step="0.01" onchange="updatePrice('${product.sku || product.id}', this.value, 'msrp')" 
              placeholder="$0.00" title="Manufacturer Suggested Retail Price">
          </td>
          <td>
            <input type="number" class="price-input" value="${product.map || ''}" 
              step="0.01" onchange="updatePrice('${product.sku || product.id}', this.value, 'map')" 
              placeholder="Leave empty if same as MSRP" title="Minimum Advertised Price (Sale Price)">
          </td>
          <td>
            ${priceDiff ? `<span class="price-diff ${priceDiff.status}">${priceDiff.text}</span>` : 'N/A'}
          </td>
          <td>
            <input type="number" class="price-input" value="${product.psa_price || ''}" 
              step="0.01" onchange="updatePrice('${product.sku || product.id}', this.value, 'psa')" 
              placeholder="Enter PSA price">
          </td>
          <td>
            <button style="padding: 4px 8px; font-size: 0.8rem;" onclick="copyPrice('${product.sku || product.id}', 'psa')">Copy PSA</button>
            <button style="padding: 4px 8px; font-size: 0.8rem; background: #28a745;" onclick="matchLowest('${product.sku || product.id}')">Match Low</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      displayPagination();
    }

    function calculatePriceDiff(product) {
      const msrp = parseFloat(product.msrp) || 0;
      const psaPrice = parseFloat(product.psa_price) || null;

      if (!psaPrice) return null;

      const diff = msrp - psaPrice;
      const percent = ((diff / psaPrice) * 100).toFixed(1);

      if (diff > 0) {
        return { text: `PSA: -$${Math.abs(diff).toFixed(2)} (${percent}% higher)`, status: 'lower' };
      } else {
        return { text: `PSA: +$${Math.abs(diff).toFixed(2)} (${percent}% lower)`, status: 'higher' };
      }
    }

    function displayPagination() {
      const totalPages = Math.ceil(filteredProducts.length / ITEMS_PER_PAGE);
      const paginationDiv = document.getElementById('pagination');
      paginationDiv.innerHTML = '';

      if (totalPages <= 1) return;

      const prevBtn = document.createElement('button');
      prevBtn.textContent = '‚Üê Previous';
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => { currentPage--; displayProducts(); };
      paginationDiv.appendChild(prevBtn);

      const pageInfo = document.createElement('span');
      pageInfo.className = 'page-info';
      pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${filteredProducts.length} products)`;
      paginationDiv.appendChild(pageInfo);

      const nextBtn = document.createElement('button');
      nextBtn.textContent = 'Next ‚Üí';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => { currentPage++; displayProducts(); };
      paginationDiv.appendChild(nextBtn);
    }

    function updatePrice(productId, value, field) {
      const product = allProducts.find(p => (p.sku || p.id) === productId);
      if (!product) return;

      const savedPrices = JSON.parse(localStorage.getItem('modular-gunworks-prices') || '{}');
      if (!savedPrices[productId]) {
        savedPrices[productId] = { msrp: product.msrp, map: product.map, psa_price: product.psa_price };
      }

      if (field === 'msrp') {
        savedPrices[productId].msrp = parseFloat(value) || 0;
        product.msrp = parseFloat(value) || 0;
      } else if (field === 'map') {
        savedPrices[productId].map = value ? parseFloat(value) : null;
        product.map = value ? parseFloat(value) : null;
      } else if (field === 'psa') {
        savedPrices[productId].psa_price = value ? parseFloat(value) : null;
        product.psa_price = value ? parseFloat(value) : null;
      }

      localStorage.setItem('modular-gunworks-prices', JSON.stringify(savedPrices));
      displayStats();
      displayProducts();
    }

    function copyPrice(productId, source) {
      const product = allProducts.find(p => (p.sku || p.id) === productId);
      if (!product) return;

      const sourcePrice = source === 'psa' ? product.psa_price : null;
      if (!sourcePrice) {
        alert(`No PSA price entered for this product.`);
        return;
      }

      updatePrice(productId, sourcePrice, 'msrp');
      alert(`MSRP updated to PSA price: $${sourcePrice.toFixed(2)}`);
    }

    function matchLowest(productId) {
      const product = allProducts.find(p => (p.sku || p.id) === productId);
      if (!product) return;

      const psaPrice = product.psa_price ? parseFloat(product.psa_price) : Infinity;
      const lowest = Math.min(psaPrice);

      if (lowest === Infinity) {
        alert('No competitor prices entered yet.');
        return;
      }

      updatePrice(productId, lowest, 'map');
      alert(`MAP (sale price) set to competitor low: $${lowest.toFixed(2)}`);
    }

    function displayStats() {
      const statsContainer = document.getElementById('stats-container');
      const avgMsrp = (allProducts.reduce((sum, p) => sum + (p.msrp || 0), 0) / allProducts.length).toFixed(2);
      const msrpsSet = allProducts.filter(p => p.msrp).length;
      const withMapPrice = allProducts.filter(p => p.map && p.map < (p.msrp || 0)).length;

      statsContainer.innerHTML = `
        <div class="stat-card">
          <div class="stat-label">Total Products</div>
          <div class="stat-value">${allProducts.length}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Products with MSRP</div>
          <div class="stat-value">${msrpsSet}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Products w/ Sale Pricing</div>
          <div class="stat-value">${withMapPrice}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Average MSRP</div>
          <div class="stat-value">$${avgMsrp}</div>
        </div>
      `;
    }

    function exportPrices() {
      const csv = convertToCSV(filteredProducts);
      downloadCSV(csv, 'modular-gunworks-prices.csv');
    }

    function convertToCSV(products) {
      const headers = ['SKU', 'Product Name', 'Brand', 'Category', 'MSRP', 'MAP (Sale Price)', 'PSA Price'];
      const rows = products.map(p => [
        p.sku || p.id,
        `"${p.name}"`,
        p.brand || '',
        p.category,
        p.msrp || '',
        p.map || '',
        p.psa_price || ''
      ]);

      return [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }

    function resetAllPrices() {
      if (confirm('‚ö†Ô∏è This will clear all price modifications. Continue?')) {
        localStorage.removeItem('modular-gunworks-prices');
        loadProducts();
        alert('All prices reset to original values.');
      }
    }

    // Event listeners
    document.getElementById('search-box').addEventListener('input', filterProducts);
    document.getElementById('category-filter').addEventListener('change', filterProducts);
    document.getElementById('brand-filter').addEventListener('input', filterProducts);

    // Load products on page load
    loadProducts();
  </script>
</body>

</html>
